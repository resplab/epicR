---
title: "Using EPIC in R"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
vignette: >
  %\VignetteIndexEntry{UsingEPICinR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8} 
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

options(rmarkdown.html_vignette.check_title = FALSE)

```

## 1 Installation

If you do not have R installed on your computer, please go to [Appendix 1](#appendix1). Once you have R installed, you can install the **epicR** package as per the instructions below:

### Windows 7 or Later {-}
1. Download and Install the latest version of R from [https://cran.r-project.org/bin/windows/base/](https://cran.r-project.org/bin/windows/base/)
2. Download and Install R Studio from [https://posit.co/download/rstudio-desktop/](https://posit.co/download/rstudio-desktop/)
3. Download and Install the latest version of Rtools from [https://cran.r-project.org/bin/windows/Rtools/](https://cran.r-project.org/bin/windows/Rtools/)
4. Using either an R session in Terminal or in R Studio, install the package `pak`:

```{r, eval=FALSE, echo=TRUE}
install.packages('pak')
```

5. Install epicR from GitHub:

```{r, eval=FALSE, echo=TRUE}
pak::pkg_install('resplab/epicR')
```

### Mac OS Sierra and Later {-}

1. Download and Install the latest version of R from [https://cran.r-project.org/bin/macosx/](https://cran.r-project.org/bin/macosx/)
2. Download and Install R Studio from [https://posit.co/download/rstudio-desktop/](https://posit.co/download/rstudio-desktop/)
3. Install Xcode Command Line Tools by running the following in Terminal:

```bash
xcode-select --install
```

4. Using either an R session in Terminal or in R Studio, install the package `pak`:

```{r, eval=FALSE, echo=TRUE}
install.packages('pak')
```

5. Install epicR from GitHub:

```{r, eval=FALSE, echo=TRUE}
pak::pkg_install('resplab/epicR')
```

### Ubuntu 22.04 and Later {-}

1. Install R by executing the following commands in Terminal:

```bash
  sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
```
```bash
  sudo add-apt-repository 'deb [arch=amd64,i386] https://cran.rstudio.com/bin/linux/ubuntu xenial/'
```
```bash
  sudo apt-get update
```
```bash
  sudo apt-get install r-base
```
If the installation is successful, you should be able to start R:
```bash
  sudo -i R
```

2. Download and Install R Studio from [https://posit.co/download/rstudio-desktop/](https://posit.co/download/rstudio-desktop/)
3. Install `libcurl` from Terminal: 

```bash
  sudo apt-get install libcurl4-openssl-dev libssl-dev r-base-dev
```

4. Using either an R session in Terminal or in R Studio, install the package `pak`:

```r
install.packages("pak")
```

5. Install epicR from GitHub:

```r
pak::pkg_install("resplab/epicR")
```

## 2 Running the Model

Now that you have installed `epicR`, you can load the library:

```{r, eval = FALSE, echo = TRUE}
library(epicR)
```

### Recommended: Using the `simulate()` Function {-}

The easiest way to run EPIC is with the `simulate()` function, which handles all session management automatically and provides progress information:

```{r, eval = FALSE, echo = TRUE}
# Run with defaults (Canada, 20 year horizon, 60,000 agents)
results <- simulate()
print(results$basic)

# Customize parameters
results <- simulate(
  jurisdiction = "us",
  time_horizon = 10,
  n_agents = 100000
)

# Quick test with fewer agents
results <- simulate(n_agents = 10000)

# By default, you get both basic and extended results
results <- simulate()
print(results$extended)

# Get event history
results <- simulate(return_events = TRUE, n_agents = 10000)
head(results$events)
```

### Advanced: Custom Input Parameters {-}

For advanced users who need fine-grained control over input parameters, you can modify inputs before simulation.

#### Understanding Input Structure {-}

The default input values are created in the file **input.R**. You can retrieve these values using `get_input()`. This function returns a nested list. The returned list contains `values`, `help` and `ref` which each hold further sub-lists. `help` and `ref` contain explanations regarding what each input parameter means. 

For easier notation we will refer the retrieved inputs as `input`:

```{r, eval = FALSE, echo = TRUE}
input <- get_input()
```

Below is a list of the main categories that `input$values` returns:

**Input Value Categories:**

| Category | Description |
|----------|-------------|
| `global_parameters` | Time horizon, age ranges, discount rates |
| `agent` | Population demographics (sex distribution, etc.) |
| `smoking` | Smoking initiation, cessation, and relapse rates |
| `diagnosis` | COPD diagnosis and case detection parameters |
| `cost` | Healthcare costs (exacerbations, medications, maintenance) |
| `medication` | Medication usage and effectiveness parameters |
| `exacerbation` | Exacerbation rates and severity distributions |
| `events` | Event-specific parameters |

`input$values` returns a list of lists, so you can further explore and set specific inputs using the `$` operator. An example of how to do this is shown below:

```{r, eval = FALSE, echo = TRUE}
# Changing time_horizon which can be accessed through global_parameters
input$values$global_parameters$time_horizon <- 5
# Changing age0, which can be accessed through global_parameters, from the default value of 40 to 50
input$values$global_parameters$age0 <- 50
# Changing p_females, which can be accessed through agent, from the default value 0.5 to 0.6
input$values$agent$p_female <- 0.6

# Run simulation with custom inputs
results <- simulate(input = input$values)
```

#### Getting Results {-}

The `simulate()` function returns a comprehensive list of results. By default, it includes both basic and extended results:

```{r, eval=FALSE, echo=TRUE}
# Run simulation
results <- simulate(n_agents = 50000)

# Access basic results
basic <- results$basic
# Access extended results  
extended <- results$extended
```

**Basic Output from `results$basic`:**

| Output | Description |
|--------|-------------|
| `n_agents` | Total number of agents simulated |
| `cumul_time` | Cumulative time in person-years |
| `n_deaths` | Total number of deaths |
| `n_COPD` | Number of agents with COPD |
| `n_exac_mild` | Number of mild exacerbations |
| `n_exac_moderate` | Number of moderate exacerbations |
| `n_exac_severe` | Number of severe exacerbations |
| `n_exac_very_severe` | Number of very severe exacerbations |
| `total_cost` | Total healthcare costs |
| `total_qaly` | Total quality-adjusted life years |

Extended results are included by default in `results$extended`:

```{r, eval=FALSE, echo=TRUE}
# Extended results are available automatically
extended <- results$extended
```

**Extended Output from `results$extended`:**

The extended output includes detailed breakdowns by:
- Year (annual results over the time horizon)
- Age groups
- Sex
- COPD severity (GOLD stages)
- Smoking status

Key tables in the extended output:
- `n_death` - Deaths by year, age, sex
- `n_COPD` - COPD prevalence by year, age, sex
- `cost` - Costs by year and category
- `qaly` - QALYs by year and health state
- `exacerbation` - Exacerbations by year, severity, and GOLD stage

**Important Notes:**
- EPIC only starts simulating patients at age 40
- Comorbidities are not implemented in the current version of epicR

#### Event History {-}

For some studies, having access to the entire event history of the simulated population might be beneficial. You can capture event history using the `return_events` parameter:

```{r, eval=FALSE, echo=TRUE}
# Get event history along with results
results <- simulate(
  n_agents = 10000,
  return_events = TRUE
)

# Access the events
events <- results$events
head(events)
```

Alternatively, you can set `record_mode` as a `setting`:

```{r, eval=FALSE, echo=TRUE}
settings <- get_default_settings()
# record_mode = 2 indicates recording every event that occurs
settings$record_mode <- 2
# n_base_agents is the number of people at time 0
settings$n_base_agents <- 1e4

# Run simulation with settings
results <- simulate(settings = settings, return_events = TRUE)
events <- results$events
head(events)
```

Note that you might need a large amount of memory available if you want to collect event history for a large number of patients.

You can change the record mode of the simulation by accessing `settings$record_mode` as shown above. Here are what different record modes mean:

**Record Modes:**

| Mode | Description |
|------|-------------|
| 0 | Aggregate output only (minimal memory) |
| 1 | Agent-level summary statistics |
| 2 | Complete event history for all agents (high memory usage) |

The event matrix consists of 33 columns, including:

**Key Event Matrix Columns:**

| Column | Description |
|--------|-------------|
| `agent_id` | Unique identifier for each agent |
| `event` | Event type code (see table below) |
| `time` | Time of event occurrence |
| `age` | Age of agent at event |
| `sex` | Sex of agent (0=male, 1=female) |
| `smoking_status` | Current smoking status |
| `COPD` | COPD status (0=no, 1=yes) |
| `gold_stage` | GOLD severity stage (0-4) |
| `exacerbation_severity` | Severity of exacerbation event |
| `cost` | Cost associated with event |
| `qaly` | QALY impact of event |


In the events data frame, each type of event has a code corresponding to the table below:

**Event Type Codes:**

| Event | Code |
|-------|------|
| Start | 0 |
| Annual | 1 |
| Birthday | 2 |
| Smoking change | 3 |
| COPD incidence | 4 |
| Exacerbation | 5 |
| Exacerbation end | 6 |
| Death by exacerbation | 7 |
| Doctor visit* | 8 |
| Medication change* | 9 |
| Background death | 13 |
| End | 14 |

*Note: Doctor visit and Medication change are not implemented in this version of epicR


### Closed-cohort analysis {-}

Closed-cohort analysis can be specified by changing the appropriate input parameters:

```{r, eval=FALSE, echo=TRUE}
library(epicR)

# Get input with closed cohort enabled
input <- get_input(closed_cohort = 1)$values

# Run simulation
results <- simulate(input = input)
```
