# Claude Code Instructions for epicR

This file contains instructions for AI assistants (like Claude) working on the epicR package.

## After Making Changes to Package Functions

Whenever you modify R functions in the `R/` directory, especially when:
- Adding new exported functions (with `@export`)
- Changing function parameters
- Updating roxygen documentation (`#'` comments)
- Adding or removing functions

**You MUST run:**

```r
devtools::document()
```

This will:
- Regenerate `man/*.Rd` documentation files
- Update the `NAMESPACE` file with exports
- Ensure the package documentation is in sync with the code

## After Making Changes

Always test that the package can be:
1. **Documented**: `devtools::document()`
2. **Loaded**: `devtools::load_all()`
3. **Checked**: `devtools::check()` (if time permits)

## Common Workflows

### Adding a New Function

1. Write the function in appropriate R file in `R/`
2. Add roxygen documentation above it:
   ```r
   #' Brief description
   #'
   #' Longer description
   #'
   #' @param param1 description
   #' @return what it returns
   #' @export
   #' @examples
   #' \dontrun{
   #' example_code()
   #' }
   function_name <- function(param1) {
     # implementation
   }
   ```
3. Run `devtools::document()`
4. Test with `devtools::load_all()`

### Modifying Function Signatures

1. Update the function parameters
2. Update the `@param` documentation
3. Run `devtools::document()`
4. Check that all examples still work

### Modifying C/C++ Code

When changing files in `src/`:
1. Make your changes
2. Run `devtools::load_all()` (recompiles automatically)
3. Test thoroughly
4. Run `devtools::check()` to ensure no compilation warnings

### Updating Vignettes

After modifying `.Rmd` files in `vignettes/`:
1. Knit the vignette to test: `rmarkdown::render("vignettes/filename.Rmd")`
2. Build vignettes: `devtools::build_vignettes()`
3. Check the output HTML looks correct

## Package-Specific Notes

### Configuration Files

The package uses JSON config files in `inst/config/`:
- `config_canada.json` - Canadian parameters
- `config_us.json` - US parameters

Each config must have a `"jurisdiction"` field at the top level.

### Session Management

The package has two APIs:
1. **Simple**: `simulate()` - handles sessions automatically
2. **Advanced**: Manual `init_session()` + `run()` + `terminate_session()`

Keep both working for backward compatibility.

### Memory Management

The C++ engine allocates memory for simulations. Always:
- Test memory cleanup with `terminate_session()`
- Check for memory leaks in long-running sessions
- Verify auto-cleanup works in `simulate()`

### Compilation

The package includes:
- C++ code using Rcpp/RcppArmadillo
- A `configure` script that checks for gfortran
- Platform-specific compilation via `Makevars.in`

Don't modify `src/Makevars` directly - it's generated by `configure`.

## Testing Checklist

Before committing changes to package functions:

- [ ] Run `devtools::document()`
- [ ] Run `devtools::load_all()` successfully
- [ ] Test the changed functions interactively
- [ ] Verify no new warnings in `devtools::check()`
- [ ] Update relevant vignettes if user-facing changes
- [ ] Update README.md if it affects the Quick Guide

## Git Workflow

1. Make changes
2. Run `devtools::document()` if needed
3. Test changes
4. Stage files: `git add <files>`
5. Commit with descriptive message
6. Push to GitHub

## Common Issues

### "object not found" after adding function
- Forgot to run `devtools::document()`
- Missing `@export` tag

### NAMESPACE conflicts
- Run `devtools::document()` to regenerate
- Check for duplicate `@export` tags

### Vignette won't build
- Check that all R code chunks have `eval=FALSE` for examples that need sessions
- Ensure package dependencies are in `DESCRIPTION`

## Resources

- [R Packages Book](https://r-pkgs.org/)
- [roxygen2 documentation](https://roxygen2.r-lib.org/)
- [Rcpp documentation](https://www.rcpp.org/)
