<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calibrate Demographics • epicR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibrate Demographics">
<style>
/* Event table styles */
.event-table table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 1em;
    font-family: Arial, sans-serif;
    text-align: left;
    border: none;
}
.event-table table th {
    background-color: #f3f4f5;
    font-weight: bold;
    border-bottom: 3px solid #333;
    padding: 10px;
}
.event-table table td {
    padding: 8px;
}
.event-table table tr:nth-child(even) {
    background-color: #f3f4f5;
}
.event-table table tr:nth-child(odd) {
    background-color: #ffffff;
}

/* Dropdown table styles */
.custom-table-container-dropdown table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 1em;
    font-family: Arial, sans-serif;
    text-align: left;
    border: 1px solid #ddd;
}
.custom-table-container-dropdown table th {
    background-color: #f3f4f5;
    font-weight: bold;
    border-bottom: 3px solid #333;
    padding: 10px;
    text-align: left;
}
.custom-table-container-dropdown table td {
    padding: 8px;
}
.btn-primary {
    color: #fff;
    background-color: #007bff;
    border: none;
    padding: 5px 10px;
    font-size: 0.9em;
    cursor: pointer;
    border-radius: 3px;
}
.btn-primary:hover {
    background-color: #0056b3;
}
.custom-collapse {
    margin-top: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    background-color: #f9f9f9;
    display: none;
}
.custom-collapse.show {
    display: block;
}

/* General table styles */
.custom-table-container table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 1em;
    font-family: Arial, sans-serif;
    text-align: left;
    border: 1px solid #ddd;
}
.custom-table-container table th {
    background-color: #f3f4f5;
    font-weight: bold;
    border-bottom: 3px solid #333;
    padding: 10px;
    text-align: left;
}
.custom-table-container table td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
}
.custom-table-container table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.custom-table-container table tr:nth-child(odd) {
    background-color: #ffffff;
}
.custom-table-container table tr:hover {
    background-color: #b780ff;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.btn-primary').forEach(function(button) {
    button.addEventListener('click', function() {
      var target = document.querySelector(button.getAttribute('data-target'));
      if (target) {
        target.classList.toggle('show');
      }
    });
  });
});
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epicR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/AddingNewCountry.html">Adding a New Country to epicR</a></li>
    <li><a class="dropdown-item" href="../articles/BackgroundEPIC.html">EPIC Background</a></li>
    <li><a class="dropdown-item" href="../articles/Calibrate_COPD_Exacerbations.html">Calibrate COPD Exacerbations</a></li>
    <li><a class="dropdown-item" href="../articles/Calibrate_COPD_Prevalence.html">Calibrate COPD Prevalence</a></li>
    <li><a class="dropdown-item" href="../articles/Calibrate_Demographics.html">Calibrate Demographics</a></li>
    <li><a class="dropdown-item" href="../articles/Calibrate_Smoking.html">Calibrate Smoking Status</a></li>
    <li><a class="dropdown-item" href="../articles/GettingStarted.html">Getting Started with EPIC</a></li>
    <li><a class="dropdown-item" href="../articles/Payoffs.html">Payoffs</a></li>
    <li><a class="dropdown-item" href="../articles/RecalibratingEPIC.html">RecalibratingEPIC</a></li>
    <li><a class="dropdown-item" href="../articles/Reproducing_bgd.html">Reproducing Background Mortality</a></li>
    <li><a class="dropdown-item" href="../articles/UsingEPICinR.html">Using EPIC in R</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Calibrate Demographics</h1>
            
      

      <div class="d-none name"><code>Calibrate_Demographics.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we will walk through the process of optimizing
parameters for two equations: the longevity equation
<code>l_inc_betas</code> and the incidence equation
<code>ln_h_bgd_betas</code>. Specifically, we aim to optimize these
parameters to minimize the Root Mean Squared Error (RMSE) between the
projected population sizes and actual U.S. population data for certain
age groups.</p>
<p>We perform optimization using the optim function in R, and the goal
is to fine-tune the model’s parameters so that the RMSE is minimized. We
focus on two specific age groups for optimization—40-59 and 60-79—while
excluding the 80+ age group, as the RMSE for this group was
significantly high, contributing excessively to the overall error.</p>
<div class="section level3">
<h3 id="step-1load-libraries-and-setup">Step 1:Load Libraries and Setup<a class="anchor" aria-label="anchor" href="#step-1load-libraries-and-setup"></a>
</h3>
<p>Here, we load the necessary libraries. We also set the default
simulation settings and specify the time horizon for the simulation (56
years).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">epicR</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">USSimulation</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"USCensus.csv"</span>, package <span class="op">=</span> <span class="st">"epicR"</span><span class="op">)</span><span class="op">)</span></span>
<span>                         </span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_default_settings.html">get_default_settings</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">record_mode</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">n_base_agents</span> <span class="op">&lt;-</span> <span class="va">settings</span><span class="op">$</span><span class="va">n_base_agents</span></span>
<span></span>
<span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_input.html">get_input</a></span><span class="op">(</span>jurisdiction <span class="op">=</span> <span class="st">"us"</span><span class="op">)</span></span>
<span><span class="va">time_horizon</span> <span class="op">&lt;-</span> <span class="fl">56</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">global_parameters</span><span class="op">$</span><span class="va">time_horizon</span> <span class="op">&lt;-</span> <span class="va">time_horizon</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-define-the-rmse-calculation-function">Step 2: Define the RMSE Calculation Function<a class="anchor" aria-label="anchor" href="#step-2-define-the-rmse-calculation-function"></a>
</h3>
<p>The <code>calculate_rmse_optim</code> function calculates the RMSE
for each iteration of parameter optimization. Within this function:</p>
<ol style="list-style-type: decimal">
<li>We assign the first three values of the parameter vector
(params[1:3]) to l_inc_betas, which represents parameters for the
longevity equation.</li>
<li>The next four values (params[4:7]) are assigned to the
ln_h_bgd_betas vector, which is part of the incidence equation. 3)The
model is then run using the updated parameters, and we extract the
projected population sizes (EPIC_popsize) and calculate the RMSE between
the projected and observed U.S. population data for the specified age
ranges.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># RMSE function for optimization</span></span>
<span><span class="va">calculate_rmse_optim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/init_session.html">init_session</a></span><span class="op">(</span>settings <span class="op">=</span> <span class="va">settings</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#assigning first 3 values to l_inc_betas</span></span>
<span>  <span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">agent</span><span class="op">$</span><span class="va">l_inc_betas</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># assigning the next 4 values to the first four ln_h_bgd_betas, others = 0</span></span>
<span>  <span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">agent</span><span class="op">$</span><span class="va">ln_h_bgd_betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    intercept <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>    y <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>    y2 <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>    age <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>,</span>
<span>    b_mi <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    n_mi <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    b_stroke <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    n_stroke <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    hf <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>input<span class="op">=</span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">)</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_output_ex.html">get_output_ex</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/terminate_session.html">terminate_session</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="va">epic_popsize_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2015</span>, by <span class="op">=</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">time_horizon</span><span class="op">)</span>,</span>
<span>                                 <span class="va">output</span><span class="op">$</span><span class="va">n_alive_by_ctime_age</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">epic_popsize_age</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">epic_popsize_age</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">epic_popsize_age</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">epic_popsize_age</span> <span class="op">&lt;-</span> <span class="va">epic_popsize_age</span><span class="op">[</span>, <span class="op">-</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">40</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">epic_popsize_age_long</span> <span class="op">&lt;-</span> <span class="va">epic_popsize_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">year</span>, names_to <span class="op">=</span> <span class="st">"age"</span>, values_to <span class="op">=</span> <span class="st">"EPIC_popsize"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="va">validate_pop_size_scaled</span> <span class="op">&lt;-</span> <span class="va">USSimulation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>US_popsize <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">epic_popsize_age_long</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"age"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>EPIC_output_scaled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2015</span>, <span class="va">US_popsize</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># calculate total population and growth rates</span></span>
<span>  <span class="va">total_epic_by_year</span> <span class="op">&lt;-</span> <span class="va">validate_pop_size_scaled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>total_EPIC_output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EPIC_popsize</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>growth_rate <span class="op">=</span> <span class="va">total_EPIC_output</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">total_EPIC_output</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="va">df_with_growth</span> <span class="op">&lt;-</span> <span class="va">validate_pop_size_scaled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">total_epic_by_year</span>, by <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      EPIC_output_scaled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2015</span>, <span class="va">US_popsize</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      EPIC_output_scaled <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">EPIC_output_scaled</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">US_popsize</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumprod</a></span><span class="op">(</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">growth_rate</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># filter and sum population data by age group (40-59 and 60-79)</span></span>
<span>  <span class="va">df_summed_ranges</span> <span class="op">&lt;-</span> <span class="va">df_with_growth</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      age_group <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">40</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">59</span> <span class="op">~</span> <span class="st">"40-59"</span>,</span>
<span>        <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">60</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">79</span> <span class="op">~</span> <span class="st">"60-79"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age_group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"40-59"</span>, <span class="st">"60-79"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">age_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>total_EPIC_population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EPIC_output_scaled</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              total_US_population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">US_popsize</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># calculating RMSE of each age group across years</span></span>
<span>  <span class="va">rmse_per_range</span> <span class="op">&lt;-</span> <span class="va">df_summed_ranges</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>      rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">total_EPIC_population</span> <span class="op">-</span> <span class="va">total_US_population</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># summing all the age ranges</span></span>
<span>  <span class="va">total_rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">rmse_per_range</span><span class="op">$</span><span class="va">rmse</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Params:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">params</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"RMSE:"</span>, <span class="va">total_rmse</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">total_rmse</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-define-initial-guess-bounds-and-run-optimization">Step 3: Define Initial Guess, Bounds, and Run Optimization<a class="anchor" aria-label="anchor" href="#step-3-define-initial-guess-bounds-and-run-optimization"></a>
</h3>
<p>We now define our initial guess for the parameters and set the bounds
for each parameter. The optimization method used is L-BFGS-B, which is
well-suited for differentiable functions with bounds. We also specify
the stopping criterion.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">initial_guess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.5</span>, <span class="fl">0.0005</span>, <span class="op">-</span><span class="fl">0.00005</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">0.025</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lower_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.6</span>, <span class="fl">0.0001</span>, <span class="op">-</span><span class="fl">0.0001</span>, <span class="op">-</span><span class="fl">0.0005</span>, <span class="op">-</span><span class="fl">0.0001</span>, <span class="op">-</span><span class="fl">0.0005</span>, <span class="op">-</span><span class="fl">0.0005</span><span class="op">)</span></span>
<span><span class="va">upper_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.45</span>, <span class="fl">0.01</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># here i am using L-BFGS-B because RMSE is a differentiable function</span></span>
<span><span class="co"># we can define lower and upper bounds,</span></span>
<span><span class="co">#more memory efficient in BFGS, making it suitable for large parameter spaces.</span></span>
<span><span class="va">result_optim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span></span>
<span>  par <span class="op">=</span> <span class="va">initial_guess</span>,</span>
<span>  fn <span class="op">=</span> <span class="va">calculate_rmse_optim</span>,</span>
<span>  lower <span class="op">=</span> <span class="va">lower_bounds</span>,</span>
<span>  upper <span class="op">=</span> <span class="va">upper_bounds</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">20</span>, iterlim <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Optimal Growth Rate:"</span>, <span class="va">result_optim</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Optimized RMSE:"</span>, <span class="va">result_optim</span><span class="op">$</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-4-optimal-parameters-and-result">Step 4: Optimal Parameters and Result<a class="anchor" aria-label="anchor" href="#step-4-optimal-parameters-and-result"></a>
</h3>
<p>After running the optimization process, we obtain the optimal values
for the parameters. These values minimize the RMSE for the specified age
groups (40-59 and 60-79) and exclude the 80+ age group.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.48672063032448</span>, <span class="fl">0.00202274171887977</span>, <span class="op">-</span><span class="fl">4.37035899506131e-05</span>, </span>
<span>            <span class="fl">0</span>, <span class="op">-</span><span class="fl">1e-04</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">0.000132065698144107</span><span class="op">)</span></span></code></pre></div>
<p>These are the optimized parameters that yield the lowest RMSE, and
they reflect the best possible values for the model in terms of
population size predictions for the selected age groups.</p>
</div>
<div class="section level3">
<h3 id="visualization">Visualization<a class="anchor" aria-label="anchor" href="#visualization"></a>
</h3>
<p>In this section, we visualize and compare the population trends over
time for different age groups using the optimized parameters and U.S.
population data.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mohsen Sadatsafavi, Amin Adibi, Kate Johnson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
