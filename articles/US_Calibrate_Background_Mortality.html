<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>US_Calibrate Background Mortality • epicR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="US_Calibrate Background Mortality">
<style>
/* Event table styles */
.event-table table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 1em;
    font-family: Arial, sans-serif;
    text-align: left;
    border: none;
}
.event-table table th {
    background-color: #f3f4f5;
    font-weight: bold;
    border-bottom: 3px solid #333;
    padding: 10px;
}
.event-table table td {
    padding: 8px;
}
.event-table table tr:nth-child(even) {
    background-color: #f3f4f5;
}
.event-table table tr:nth-child(odd) {
    background-color: #ffffff;
}

/* Dropdown table styles */
.custom-table-container-dropdown table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 1em;
    font-family: Arial, sans-serif;
    text-align: left;
    border: 1px solid #ddd;
}
.custom-table-container-dropdown table th {
    background-color: #f3f4f5;
    font-weight: bold;
    border-bottom: 3px solid #333;
    padding: 10px;
    text-align: left;
}
.custom-table-container-dropdown table td {
    padding: 8px;
}
.btn-primary {
    color: #fff;
    background-color: #007bff;
    border: none;
    padding: 5px 10px;
    font-size: 0.9em;
    cursor: pointer;
    border-radius: 3px;
}
.btn-primary:hover {
    background-color: #0056b3;
}
.custom-collapse {
    margin-top: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    background-color: #f9f9f9;
    display: none;
}
.custom-collapse.show {
    display: block;
}

/* General table styles */
.custom-table-container table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 1em;
    font-family: Arial, sans-serif;
    text-align: left;
    border: 1px solid #ddd;
}
.custom-table-container table th {
    background-color: #f3f4f5;
    font-weight: bold;
    border-bottom: 3px solid #333;
    padding: 10px;
    text-align: left;
}
.custom-table-container table td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
}
.custom-table-container table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.custom-table-container table tr:nth-child(odd) {
    background-color: #ffffff;
}
.custom-table-container table tr:hover {
    background-color: #b780ff;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.btn-primary').forEach(function(button) {
    button.addEventListener('click', function() {
      var target = document.querySelector(button.getAttribute('data-target'));
      if (target) {
        target.classList.toggle('show');
      }
    });
  });
});
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epicR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/AddingNewCountry.html">Adding a New Country to epicR</a></li>
    <li><a class="dropdown-item" href="../articles/BackgroundEPIC.html">EPIC Background</a></li>
    <li><a class="dropdown-item" href="../articles/Canada_Calibrate_COPD_Exacerbations.html">Canada_Calibrate COPD Exacerbations</a></li>
    <li><a class="dropdown-item" href="../articles/GettingStarted.html">Getting Started with EPIC</a></li>
    <li><a class="dropdown-item" href="../articles/US_Calibrate_Background_Mortality.html">US_Calibrate Background Mortality</a></li>
    <li><a class="dropdown-item" href="../articles/US_Calibrate_COPD_Exacerbations.html">US_Calibrate COPD Exacerbations</a></li>
    <li><a class="dropdown-item" href="../articles/US_Calibrate_COPD_Prevalence.html">US_Calibrate COPD Prevalence</a></li>
    <li><a class="dropdown-item" href="../articles/US_Calibrate_Demographics.html">US_Calibrate Demographics</a></li>
    <li><a class="dropdown-item" href="../articles/US_Calibrate_Smoking_Status.html">US_Calibrate Smoking Status</a></li>
    <li><a class="dropdown-item" href="../articles/US_Payoffs.html">US_Payoffs</a></li>
    <li><a class="dropdown-item" href="../articles/UsingEPICinR.html">Using EPIC in R</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>US_Calibrate Background Mortality</h1>
            
      

      <div class="d-none name"><code>US_Calibrate_Background_Mortality.Rmd</code></div>
    </div>

    
    
<p>In this document, we aim to explore how the model behaves when
COPD-related mortality is turned off. Specifically, our goal is to
observe probability of death values that closely align with the
background mortality rates from official U.S. sources. This is the
expected behavior, as disabling exacerbation-related deaths causes the
model to no longer predict mortality from exacerbations, which should
result in values matching the background mortality rates.</p>
<p>To achieve this, we followed the series of steps below:</p>
<div class="section level3">
<h3 id="step-1-shutting-off-exacerbation-related-mortality-">Step 1: Shutting off exacerbation related mortality.<a class="anchor" aria-label="anchor" href="#step-1-shutting-off-exacerbation-related-mortality-"></a>
</h3>
<p>First, we set the intercept of the exacerbation equation to a high
value, effectively disabling death from exacerbations in the model. This
adjustment is made by changing the relevant variable as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">epicR</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"epicR"</span><span class="op">)</span></span>
<span><span class="va">input</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_input.html">get_input</a></span><span class="op">(</span>jurisdiction <span class="op">=</span> <span class="st">"us"</span><span class="op">)</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">exacerbation</span><span class="op">$</span><span class="va">logit_p_death_by_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  male <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="op">-</span><span class="fl">13000</span>, age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.05</span><span class="op">)</span>, mild <span class="op">=</span> <span class="fl">0</span>, moderate <span class="op">=</span> <span class="fl">0</span>, severe <span class="op">=</span> <span class="fl">7.4</span>,</span>
<span>    very_severe <span class="op">=</span> <span class="fl">8</span>, n_hist_severe_exac <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  female <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="op">-</span><span class="fl">13000</span>, age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.05</span><span class="op">)</span>, mild <span class="op">=</span> <span class="fl">0</span>, moderate <span class="op">=</span> <span class="fl">0</span>, severe <span class="op">=</span> <span class="fl">7.4</span>,</span>
<span>    very_severe <span class="op">=</span> <span class="fl">8</span>, n_hist_severe_exac <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#also setting exlicit mortality = 0 so there is no correction made</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">manual</span><span class="op">$</span><span class="va">explicit_mortality_by_age_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>    male <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">111</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    female <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">111</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-setting-longevitiy-related-parameters-to-0-">Step 2: Setting longevitiy-related parameters to 0.<a class="anchor" aria-label="anchor" href="#step-2-setting-longevitiy-related-parameters-to-0-"></a>
</h3>
<p>Longevity is another factor in the model that influences population.
To ensure that no external factors impact the population, we set these
parameters to 0. This adjustment can be made in the input.R file.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">agent</span><span class="op">$</span><span class="va">ln_h_bgd_betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span>, y2 <span class="op">=</span> <span class="fl">0</span>, age <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                            b_mi <span class="op">=</span> <span class="fl">0</span>, n_mi <span class="op">=</span> <span class="fl">0</span>, b_stroke <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                            n_stroke <span class="op">=</span> <span class="fl">0</span>, hf <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-run-the-model-for-1-year-and-retrieve-events-matrix">Step 3: Run the model for 1 year and retrieve events matrix<a class="anchor" aria-label="anchor" href="#step-3-run-the-model-for-1-year-and-retrieve-events-matrix"></a>
</h3>
<p>Initially we run the model for 1 year and get the events matrix. This
matrix logs all the events that individuals go through thoughout the
model. We will use this matrix to calculate death probabilities produced
by epicR</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">epicR</span><span class="op">)</span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_default_settings.html">get_default_settings</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">record_mode</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">n_base_agents</span> <span class="op">&lt;-</span> <span class="fl">3.5e5</span></span>
<span></span>
<span><span class="co"># input &lt;- get_input(jurisdiction = "us")</span></span>
<span></span>
<span><span class="co"># set time horizon as 1 initially </span></span>
<span><span class="va">time_horizon</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">global_parameters</span><span class="op">$</span><span class="va">time_horizon</span> <span class="op">&lt;-</span> <span class="va">time_horizon</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span>settings <span class="op">=</span> <span class="va">settings</span>, input <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">values</span>, return_events <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">events</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">events</span></span>
<span></span>
<span><span class="co"># checking to make sure event 7 (death by exacerbation) is not included </span></span>
<span><span class="co"># because we shut that off in the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">events</span><span class="op">$</span><span class="va">event</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">events</span><span class="op">$</span><span class="va">event</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-4-calculating-probability-of-death-from-events-matrix">Step 4: Calculating probability of death from events matrix<a class="anchor" aria-label="anchor" href="#step-4-calculating-probability-of-death-from-events-matrix"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we will group by age so we convert ages into whole numbers.</span></span>
<span><span class="va">events</span> <span class="op">&lt;-</span> <span class="va">events</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age_and_local <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">local_time</span> <span class="op">+</span> <span class="va">age_at_creation</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter events to identify individuals who have experienced event 14,</span></span>
<span><span class="co"># while also creating a flag for whether they ever experienced event 13 (death)</span></span>
<span><span class="va">events_filtered</span><span class="op">&lt;-</span> <span class="va">events</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>death<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">13</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ever_death <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">death</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">14</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># calculationg probability of death</span></span>
<span><span class="va">death_prob</span><span class="op">&lt;-</span> <span class="va">events_filtered</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">age_and_local</span>, <span class="va">female</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    total_count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    death_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ever_death</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    death_probability <span class="op">=</span> <span class="va">death_count</span> <span class="op">/</span> <span class="va">total_count</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inspecting-the-results">Inspecting the results<a class="anchor" aria-label="anchor" href="#inspecting-the-results"></a>
</h3>
<p>We should not consider 40 year-olds beause (Amin said … )</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">death_prob</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">death_prob</span>,<span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>While these values are not perfectly aligned with our validation
target, the variation is negligible.</p>
<p>Next, we want to ensure a consistent directional effect. We expect
that increasing time_horizon to 5 years will bring the results closer to
our target.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># set time horizon to 5</span></span>
<span><span class="va">time_horizon</span> <span class="op">&lt;-</span> <span class="fl">6</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">global_parameters</span><span class="op">$</span><span class="va">time_horizon</span> <span class="op">&lt;-</span> <span class="va">time_horizon</span></span>
<span></span>
<span><span class="va">results5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span>settings <span class="op">=</span> <span class="va">settings</span>, input <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">values</span>, return_events <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">events5</span> <span class="op">&lt;-</span> <span class="va">results5</span><span class="op">$</span><span class="va">events</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">events</span><span class="op">$</span><span class="va">event</span><span class="op">)</span></span>
<span></span>
<span><span class="va">events5</span> <span class="op">&lt;-</span> <span class="va">events5</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age_and_local <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">local_time</span> <span class="op">+</span> <span class="va">age_at_creation</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">events5</span> <span class="op">&lt;-</span> <span class="va">events5</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>local_time_adj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">events5</span><span class="op">$</span><span class="va">local_time</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># withing that year have they ever died?</span></span>
<span><span class="va">events5_filtered</span><span class="op">&lt;-</span> <span class="va">events5</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>death<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">13</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>,<span class="va">local_time_adj</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ever_death <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">death</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">14</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">death_prob5</span><span class="op">&lt;-</span> <span class="va">events5_filtered</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">age_and_local</span>, <span class="va">female</span>, <span class="va">local_time_adj</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    total_count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    death_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ever_death</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    death_probability <span class="op">=</span> <span class="va">death_count</span> <span class="op">/</span> <span class="va">total_count</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Now, when we check the results. We see that the results are even
further away:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">death_prob5</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">death_prob5</span>,<span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-results">Visualizing results<a class="anchor" aria-label="anchor" href="#visualizing-results"></a>
</h3>
<p>To better understand the differences, we visualize the results and
compare them against the target values.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">death_prob_clean</span> <span class="op">&lt;-</span> <span class="va">death_prob</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">age_and_local</span>, <span class="va">female</span>, <span class="va">death_probability</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">female</span>, values_from <span class="op">=</span> <span class="va">death_probability</span>, names_prefix <span class="op">=</span> <span class="st">"sex_"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">death_prob_clean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Age"</span>, <span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">USlifetables_num</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">agent</span><span class="op">$</span><span class="va">p_bgd_by_sex</span></span>
<span></span>
<span></span>
<span><span class="va">USlifetables_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Age <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">USlifetables_num</span><span class="op">)</span>,  <span class="co"># Start age from 1</span></span>
<span>  Male <span class="op">=</span> <span class="va">USlifetables_num</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>  Female <span class="op">=</span> <span class="va">USlifetables_num</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">common_ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">death_prob_clean</span><span class="op">$</span><span class="va">Age</span>, <span class="va">USlifetables_df</span><span class="op">$</span><span class="va">Age</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># filter both so only include the rows with matching Age</span></span>
<span><span class="va">death_prob_filtered</span> <span class="op">&lt;-</span> <span class="va">death_prob_clean</span><span class="op">[</span><span class="va">death_prob_clean</span><span class="op">$</span><span class="va">Age</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">common_ages</span>, <span class="op">]</span></span>
<span><span class="va">USlifetables_filtered</span> <span class="op">&lt;-</span> <span class="va">USlifetables_df</span><span class="op">[</span><span class="va">USlifetables_df</span><span class="op">$</span><span class="va">Age</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">common_ages</span>, <span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_data_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">death_prob_filtered</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Source <span class="op">=</span> <span class="st">"epicR"</span><span class="op">)</span>,</span>
<span>  <span class="va">USlifetables_filtered</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Source <span class="op">=</span> <span class="st">"US Life Tables"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"Sex"</span>, values_to <span class="op">=</span> <span class="st">"Death_Probability"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Age</span> <span class="op">&gt;</span> <span class="fl">40</span><span class="op">)</span>  </span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">combined_data_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Age</span>, y <span class="op">=</span> <span class="va">Death_Probability</span>, fill <span class="op">=</span> <span class="va">Source</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Sex</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Comparison of epicR Death Probability vs. US Life Tables (time_horizon =1)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Death Probability"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Source:"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"center"</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>When <code>time_horizon = 6</code>, we get the following plot.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_data_long5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">death_prob5_filtered</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Source <span class="op">=</span> <span class="st">"epicR"</span><span class="op">)</span>,</span>
<span>  <span class="va">USlifetables_filtered</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Source <span class="op">=</span> <span class="st">"US Life Tables"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"Sex"</span>, values_to <span class="op">=</span> <span class="st">"Death_Probability"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Age</span> <span class="op">&gt;</span> <span class="fl">40</span><span class="op">)</span>  </span>
<span></span>
<span></span>
<span><span class="va">final_EPIC_death5</span><span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">combined_data_long5</span>, <span class="va">Source</span> <span class="op">==</span> <span class="st">"epicR"</span><span class="op">)</span></span>
<span><span class="va">final_US_death</span><span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">combined_data_long5</span>, <span class="va">Source</span> <span class="op">==</span> <span class="st">"US Life Tables"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add Death_Probability to USlifetables_filtered</span></span>
<span><span class="va">USlifetables_filtered_long</span> <span class="op">&lt;-</span> <span class="va">USlifetables_filtered</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"Sex"</span>, value <span class="op">=</span> <span class="st">"Death_Probability"</span>, <span class="va">Male</span>, <span class="va">Female</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through each unique year in the combined_data_long dataset</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">year</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">combined_data_long5</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Filter the data for the current year</span></span>
<span>  <span class="va">year_data</span> <span class="op">&lt;-</span> <span class="va">combined_data_long5</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">==</span> <span class="va">year</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create the plot for the current year</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">combined_data_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Age</span>, y <span class="op">=</span> <span class="va">Death_Probability</span>, fill <span class="op">=</span> <span class="va">Source</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Sex</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Comparison of epicR Death Probability vs. US Life Tables (time_horizon = 6)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Death Probability"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Source:"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"center"</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Print the plot for the current year</span></span>
<span>  <span class="co"># print(p)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p>When we break it down and analyze per year, it seems to be in line
with what we expect.</p>
</div>
<div class="section level3">
<h3 id="eliminating-smoking-mortality">Eliminating smoking mortality<a class="anchor" aria-label="anchor" href="#eliminating-smoking-mortality"></a>
</h3>
<p>We have identified a potential source of the observed mortality
discrepancies. Specifically, the mortality ratio associated with both
former and current smokers appears to be influencing the results.</p>
<p>To investigate this, we set the following smoking-related mortality
factors to 1 (indicating no excess mortality risk for former and current
smokers):</p>
<p>After making this adjustment, the results align more closely with the
life tables.</p>
<ul>
<li>This suggests that either:
<ul>
<li>The model may be generating an excessive number of current and
former smokers, leading to higher mortality than expected.</li>
<li>We will need to update the mortality ratio estimates depending on
whether an individual currently or formerly smokes.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">smoking</span><span class="op">$</span><span class="va">mortality_factor_former</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>age40to49<span class="op">=</span><span class="fl">1</span>,age50to59<span class="op">=</span><span class="fl">1</span>,</span>
<span>                                                 age60to69<span class="op">=</span><span class="fl">1</span>,age70to79<span class="op">=</span><span class="fl">1</span>,</span>
<span>                                                 age80p<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">smoking</span><span class="op">$</span><span class="va">mortality_factor_current</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>age40to49<span class="op">=</span><span class="fl">1</span>,age50to59<span class="op">=</span><span class="fl">1</span>,</span>
<span>                                                  age60to69<span class="op">=</span><span class="fl">1</span>,age70to79<span class="op">=</span><span class="fl">1</span>,</span>
<span>                                                  age80p<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="changing-the-intercept-of-logit_p_never_smoker_con_not_current_0_betas">Changing the intercept of
<code>logit_p_never_smoker_con_not_current_0_betas</code><a class="anchor" aria-label="anchor" href="#changing-the-intercept-of-logit_p_never_smoker_con_not_current_0_betas"></a>
</h3>
<p>Currently the model has too many former smokers. This can be adjusted
by increased the intercept of
<code>logit_p_never_smoker_con_not_current_0_betas</code>. So
first,instead of changing the mortality factors, we keep the mortality
factors for current and former smokers the same.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_default_settings.html">get_default_settings</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">record_mode</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">n_base_agents</span> <span class="op">&lt;-</span> <span class="fl">1e6</span></span>
<span></span>
<span><span class="va">input</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_input.html">get_input</a></span><span class="op">(</span>jurisdiction <span class="op">=</span> <span class="st">"us"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">time_horizon</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">global_parameters</span><span class="op">$</span><span class="va">time_horizon</span> <span class="op">&lt;-</span> <span class="va">time_horizon</span></span>
<span></span>
<span><span class="co"># kept the same</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">smoking</span><span class="op">$</span><span class="va">mortality_factor_current</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>age40to49 <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                                        age50to59 <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                                        age60to69 <span class="op">=</span> <span class="fl">1.94</span>,</span>
<span>                                                        age70to79 <span class="op">=</span> <span class="fl">1.86</span>,</span>
<span>                                                        age80p <span class="op">=</span> <span class="fl">1.66</span> <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># kept the same</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">smoking</span><span class="op">$</span><span class="va">mortality_factor_former</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>age40to49 <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                                      age50to59 <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                                      age60to69 <span class="op">=</span> <span class="fl">1.54</span>,</span>
<span>                                                      age70to79 <span class="op">=</span> <span class="fl">1.36</span>,</span>
<span>                                                      age80p <span class="op">=</span> <span class="fl">1.27</span> <span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then, we adjust the intercept to ensure that the ratio of
never-smokers to the total population is approximately 0.21. We modify
the intercept accordingly to achieve this target.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Probability of being a never-smoker conditional on not being current smoker,</span></span>
<span><span class="co"># at the time of creation</span></span>
<span><span class="va">input</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">smoking</span><span class="op">$</span><span class="va">logit_p_never_smoker_con_not_current_0_betas</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">4.85</span>, sex <span class="op">=</span> <span class="fl">0</span>, age <span class="op">=</span> <span class="op">-</span><span class="fl">0.06</span>, age2 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                sex_age <span class="op">=</span> <span class="fl">0</span>,sex_age2 <span class="op">=</span> <span class="fl">0</span>, year <span class="op">=</span> <span class="op">-</span><span class="fl">0.02</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span>settings <span class="op">=</span> <span class="va">settings</span>, input <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">values</span>, return_events <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">events</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">events</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">extended</span></span>
<span></span>
<span><span class="co"># checking the ratio</span></span>
<span><span class="va">smoking_num</span><span class="op">&lt;-</span><span class="va">output</span><span class="op">$</span><span class="va">n_smoking_status_by_ctime</span></span>
<span><span class="va">never_smoker_ratio</span> <span class="op">&lt;-</span> <span class="va">smoking_num</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">smoking_num</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">never_smoker_ratio</span></span></code></pre></div>
<p>Now we can visualize the change:</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mohsen Sadatsafavi, Amin Adibi, Kate Johnson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
